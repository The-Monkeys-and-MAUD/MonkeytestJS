/*! quintrunner - v0.1.0 - 2013-03-06
* https://github.com/organizations/TheMonkeys
* Copyright (c) 2013 The Monkeys; Licensed  */
(function(e){var t=function(t){e.console&&console.log(t)},n=function(t,n){e.QUnitRunner.registerTest(t,n)},r=Object.prototype.hasOwnProperty,i=function(e,t){function i(){this.constructor=e}for(var n in t)r.call(t,n)&&(e[n]=t[n]);return t.prototype&&(i.prototype=t.prototype,e.prototype=new i,e.__super__=t.prototype),e},s=function(){};s.prototype.start=function(e,t){e=e||{},this.config={testsDir:"/tests/",pageTests:{},globalTests:[]},i(this.config,e),this.testsUrl=/^[^\/]+:\/\/[^\/]+\//.exec(location.href)[0]+this.config.testsDir,this.workspace=this.config.workspace,this.jQuery=this.config.jQuery;var n=0,r=0;t=t||[];if(t.length===0)for(n=0;n<this.config.pages.length;n++)t.push(this.config.pages[n].url);this.pagesToTest=t,this.tests={},this.testsToLoad=[],n=0,this.pages=[];for(n=0;n<this.config.pages.length;n++){var s=new o(this.config.pages[n]);s.runner=this;for(r=0;r<this.config.globalTests.length;r++)s.tests.push(this.getTest(this.config.globalTests[r]));if(this.config.pages[n].tests)for(r=0;r<this.config.pages[n].tests.length;r++)s.tests.push(this.getTest(this.config.pages[n].tests[r]));this.pages.push(s)}return this.loadNextTest(),this},s.prototype.getTest=function(e){if(!this.tests.hasOwnProperty(e)){var t=new u({src:e},this);this.tests[e]=t,this.testsToLoad.push(t)}return this.tests[e]},s.prototype.loadNextTest=function(){this.loadingCurrentTest=this.testsToLoad.shift(),this.loadingCurrentTest?this.loadingCurrentTest.load():this.loadTestsDone()},s.prototype.registerTest=function(e,n){t("->registerTest "+this.loadingCurrentTest.src+" "+e);var r=this.loadingCurrentTest;this.loadingCurrentTest.test=n,this.loadingCurrentTest.name=e,this.loadNextTest()},s.prototype.loadTestsDone=function(){this.startTests()},s.prototype.startTests=function(){t("->startTests "),t(this.tests),QUnit.start(),this.currentPage=this.pages.shift(),this.nextPageTest()},s.prototype.nextPageTest=function(){this.currentPage?this.currentPage.runNextTest()||(this.currentPage=this.pages.shift(),this.nextPageTest()):t("All test complete")};var o=function(e,t){e=e||{},i(this,e),this.source="",this.tests=[],this.currentTest=-1,this.runner=t};o.prototype.loadSource=function(e){if(this.source!==""){e();return}var t=this;this.runner.jQuery.get(this.url).success(function(n){t.source=n,e()}).error(function(){e()})},o.prototype.runNextTest=function(e){var t=this.tests.shift();if(t){var n=new a({},this.runner);return n.testSpec=t,n.runner=this.runner,n.page=this,n.window=n.workspace=this.runner.workspace,n.$=this.runner.workspace.jQuery,n.runTest(),!0}return!1};var u=function(e,t){e=e||{},i(this,e),this.runner=t};u.prototype.load=function(e){this.addTestScript("",this.src)},u.prototype.addTestScript=function(e,t){t=this.runner.testsUrl+t;var n=document,r,i=n.getElementsByTagName("script")[0];r=n.createElement("script"),r.async=!0,r.src=t,i.parentNode.insertBefore(r,i)};var a=function(e){e=e||{},i(this,e),this.chain=[]};a.prototype.runTest=function(){t("->testPageTest starting "+this.page.url+" with "+this.testSpec.name);var e=this;QUnit.module("testing "+this.page.url+" with "+this.testSpec.name);if(this.test.test instanceof Function)this.config.jQuery("#workspace").on("load",function(){e.testSpec.test.call(e,e.workspace.jQuery,0)});else{var n=0;this.testSpec.test.setup&&this.testSpec.test.setup.call(this),this.testSpec.test.load&&e.testSpec.test.load.call(e,e.workspace.jQuery)}},a.prototype.start=function(){return t("->testPageTest  "+this.page.url+":"+this.testSpec.name+" start "+this.chain.length),this._next(),this},a.prototype._next=function(){t("->testPageTest  "+this.page.url+":"+this.testSpec.name+" _next");var e=this.chain.shift();e?e.call(this):(t("->testPageTest complete "+this.page.url+" with "+this.testSpec.name),this.runner.nextPageTest())},a.prototype.env=function(){var e=this.runner.config.envs,t="notfound",n=this;return this.runner.jQuery.each(e,function(r,i){var s=e[r];n.runner.jQuery.each(s,function(e,i){if(n.runner.workspace.location.href.indexOf(i)>=0)return t=r,!1});if(t!=="notfound")return!1}),t},a.prototype.config=function(){return this.runner.config},a.prototype.loadPageSource=function(){var e=this,t=function(){e.page.loadSource(function(){e._next()})};return this.chain.push(t),this},a.prototype.loadPage=function(e){e=e||this.page.url;var t=this,n=function(){t._next(),t.runner.jQuery("#workspace").off("load",n)},r=function(){t.runner.jQuery("#workspace").on("load",n),t.runner.jQuery("#workspace").attr("src",e)};return this.chain.push(r),this},a.prototype.waitForPageLoad=function(){var e=this,t=function(){e._next(),e.runner.jQuery("#workspace").off("load",t)},n=function(){e.runner.jQuery("#workspace").on("load",t)};return this.chain.push(n),this},a.prototype.run=function(e){var t=this,n=function(){e.call(t,t.workspace.jQuery),t._next()};return this.chain.push(n),this},a.prototype.test=function(e,t){var n=this,r=function(){test(e,function(){t.call(n,n.workspace.jQuery)}),QUnit.start(),n._next()};return this.chain.push(r),this},a.prototype.asyncTest=function(e,t){var n=this,r=function(){asyncTest(e,function(){t.call(n,n.workspace.jQuery)})};return this.chain.push(r),this},a.prototype.asyncTestDone=function(){var e=this;QUnit.start(),e._next()},e.QUnitRunnerPageTest=a,e.log=t,e.registerTest=n,e.QUnitRunner=new s})(this);